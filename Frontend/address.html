<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXhW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="./address.css">
    <style>
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .popup.show {
            display: block;
        }

        .popup-overlay.show {
            display: block;
        }

        .popup.custom-bg {
            background-color: #f8f9fa;
        }

        .popup .closePopup {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            float: right;
        }


        .form-control:invalid {
            border-color: rgb(52, 51, 51);
            background-color: #ffffff;
            width: 100%
        }

        .form-control:valid {
            border-color: green;
            background-color: #e6ffe6;
        }


        @media (max-width: 768px) {
            .container.mt-5 {
                margin-top: 20px;
            }

            .btn-2,
            .btn-1 {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div id="nav-placeholder"></div>

    <script>
        $(function () {
            $("#nav-placeholder").load("nav.html", function () {
                updateCartCounter(); // Ensure counter updates after loading nav
            });
        });
    </script>

    <div class="container mt-5 yohoho">
        <div class="container mt-5 saved saving-address">
            <h2 class="mt-5">Saved Addresses</h2>
            <div class="my-address">
                <div id="savedAddresses" class="address-list mt-4"></div>
            </div>
            <div class="mt-4 center-buttons add-btn">
                <div class="add btn">
                    <button id="openAddressPopup" class="custom-add-btn">Add New Address</button>
                </div>



                <div class="add btn">
                    <a href="./payment.html">
                        <button id="proceedToPayment" class="custom-pay-btn">Go to Payment</button>
                    </a>
                </div>
            </div>
        </div>
        <br><br>
        <br><br>
    </div>

    <!-- Popup for adding addresses -->
    <div id="addressPopup" class="popup">
        <h2 id="shipping">Shipping Address</h2>
        <form id="addressForm" class="mt-4">
            <div class="mb-3">
                <label for="name" class="form-label">Full Name</label><br>
                <input type="text" class="form-control" id="name" placeholder="Enter your full name" required>

            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label><br>
                <input type="email" class="form-control" id="email" placeholder="Enter your email" required>

            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label><br>
                <input type="tel" class="form-control" id="phone" placeholder="Enter your phone number" required
                    pattern="[0-9]{10}">

            </div>
            <div class="mb-3">
                <label for="address" class="form-label">Address</label><br>
                <input type="text" class="form-control" id="address" placeholder="Enter your address" required>

            </div>
            <div class="mb-3">
                <label for="zip" class="form-label">PIN Code</label><br>
                <input type="text" class="form-control" id="pin" placeholder="Enter your PIN code" required
                    pattern="[0-9]{6}">

            </div>
            <div class="mb-3">
                <label for="city" class="form-label">City</label><br>
                <input type="text" class="form-control" id="city" placeholder="Enter your city" required>

            </div>
            <div class="mb-3">
                <label for="state" class="form-label">State</label><br>
                <select class="form-control" id="state" required>
                    <option value="">Select your state</option>
                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                    <option value="Assam">Assam</option>
                    <option value="Bihar">Bihar</option>
                    <option value="Chhattisgarh">Chhattisgarh</option>
                    <option value="Goa">Goa</option>
                    <option value="Gujarat">Gujarat</option>
                    <option value="Haryana">Haryana</option>
                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                    <option value="Jharkhand">Jharkhand</option>
                    <option value="Karnataka">Karnataka</option>
                    <option value="Kerala">Kerala</option>
                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                    <option value="Maharashtra">Maharashtra</option>
                    <option value="Manipur">Manipur</option>
                    <option value="Meghalaya">Meghalaya</option>
                    <option value="Mizoram">Mizoram</option>
                    <option value="Nagaland">Nagaland</option>
                    <option value="Odisha">Odisha</option>
                    <option value="Punjab">Punjab</option>
                    <option value="Rajasthan">Rajasthan</option>
                    <option value="Sikkim">Sikkim</option>
                    <option value="Tamil Nadu">Tamil Nadu</option>
                    <option value="Telangana">Telangana</option>
                    <option value="Tripura">Tripura</option>
                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                    <option value="Uttarakhand">Uttarakhand</option>
                    <option value="West Bengal">West Bengal</option>
                    <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                    <option value="Chandigarh">Chandigarh</option>
                    <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu
                    </option>
                    <option value="Delhi">Delhi</option>
                    <option value="Lakshadweep">Lakshadweep</option>
                    <option value="Puducherry">Puducherry</option>
                </select>
                <div class="invalid-feedback">Please select a state.</div>
            </div>
            <div class="mb-3">
                <label for="country" class="form-label">Country</label><br>
                <input type="text" class="form-control" id="country" placeholder="Enter your country" required>

            </div>
            <div class="mb-3 checkbox">
                <input type="checkbox" class="custom-checkbox" id="defaultAddressCheckbox">
                <label for="defaultAddressCheckbox">Set as your Default Address</label>
            </div>
            <div class="mt-4 center-buttons pay-btn">
                <button type="submit" class="btn btn-primary">Save Address</button>
                <button type="button" class="btn btn-secondary closePopup">Close</button>
            </div>
        </form>
    </div>

    <div id="popupOverlay" class="popup-overlay"></div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
    const openPopupBtn = document.getElementById('openAddressPopup');
    const popup = document.getElementById('addressPopup');
    const popupOverlay = document.getElementById('popupOverlay');
    const closePopupBtn = document.querySelector('.closePopup');
    const savedAddressesDiv = document.getElementById('savedAddresses');
    const addressForm = document.getElementById('addressForm');
    const proceedToPaymentBtn = document.getElementById('proceedToPayment');

    const userEmail = localStorage.getItem("userEmail"); // Fetch email from localStorage

    if (!userEmail) {
        alert("No user logged in. Redirecting to login...");
        window.location.href = "login.html";
        return;
    }

    openPopupBtn.addEventListener('click', () => {
        popup.classList.add('show');
        popupOverlay.classList.add('show');
    });

    closePopupBtn.addEventListener('click', () => {
        popup.classList.remove('show');
        popupOverlay.classList.remove('show');
    });

    popupOverlay.addEventListener('click', () => {
        popup.classList.remove('show');
        popupOverlay.classList.remove('show');
    });

    // ðŸ”¹ Fetch User Details and Addresses
    async function loadAddresses() {
        try {
            const response = await fetch(`${CONFIG.API_URL}/get-user?email=${userEmail}`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

            const user = await response.json();
            savedAddressesDiv.innerHTML = '';

            if (!user.address || user.address.length === 0) {
                savedAddressesDiv.innerHTML = '<p>No saved addresses.</p>';
                return;
            }

            let hasDefault = false;
            let addressHTML = '';

            user.address.forEach((address, index) => {
                const isChecked = address.isDefaultAddress || (!hasDefault && index === 0);
                if (isChecked) hasDefault = true;

                addressHTML += `
                <div class="saved-address-card">
                    <input type="radio" name="selectedAddress" value="${index}" id="address-${index}" ${isChecked ? "checked" : ""} required>
                    <label for="address-${index}">
                        <p><strong>${user.firstName} ${user.lastName}</strong></p>
                        <p>${address.address}, ${address.city}, ${address.state}, ${address.pin}, ${address.country}</p>
                        <p>Phone: ${user.phone}</p>
                        <p>Email: ${user.email}</p>
                        <p><strong>${address.isDefaultAddress ? "Default Address" : ""}</strong></p>
                    </label>
                </div>`;
            });

            savedAddressesDiv.innerHTML = addressHTML;
        } catch (error) {
            console.error('Error fetching user details:', error);
        }
    }

    // ðŸ”¹ Add New Address
    addressForm.addEventListener('submit', async function (event) {
        event.preventDefault();

        const newAddress = {
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pin: document.getElementById('pin').value,
            country: document.getElementById('country').value,
            isDefaultAddress: document.getElementById('defaultAddressCheckbox').checked
        };

        try {
            const response = await fetch(`${CONFIG.API_URL}/update-user-address`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail, newAddress })
            });

            const data = await response.json();
            if (response.ok) {
                console.log("Address saved successfully:", data);
                popup.classList.remove('show');
                popupOverlay.classList.remove('show');
                addressForm.reset();
                loadAddresses();
            } else {
                alert("Failed to save address. Please try again.");
            }
        } catch (error) {
            console.error("Error saving address:", error);
        }
    });

    // ðŸ”¹ Proceed to Payment
    proceedToPaymentBtn.addEventListener('click', () => {
        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
        if (!selectedAddress) {
            alert("Select an address before proceeding.");
            return;
        }

        // Get selected address details
        const addressIndex = selectedAddress.value;
        const addressElement = selectedAddress.closest('.saved-address-card');
        const name = encodeURIComponent(addressElement.querySelector('p strong').innerText);
        const details = encodeURIComponent(addressElement.querySelectorAll('p')[1].innerText);
        const phone = encodeURIComponent(addressElement.querySelectorAll('p')[2].innerText.replace("Phone: ", ""));
        const email = encodeURIComponent(addressElement.querySelectorAll('p')[3].innerText.replace("Email: ", ""));

        // Redirect to payment page with address data in URL
        window.location.href = `payment.html?name=${name}&details=${details}&phone=${phone}&email=${email}`;
    });

    loadAddresses(); // Load addresses on page load
});

// ðŸ”¹ Auto-fill Address Details using PIN Code
function fetchAddressDetails(pinCode) {
    const apiURL = `https://api.postalpincode.in/pincode/${pinCode}`;

    fetch(apiURL)
        .then(response => response.json())
        .then(data => {
            if (data[0].Status === "Success") {
                const details = data[0].PostOffice[0];
                document.getElementById('city').value = details.District;
                document.getElementById('state').value = details.State;
                document.getElementById('country').value = details.Country;
            } else {
                alert('Invalid PIN code! Please enter a valid PIN code.');
            }
        })
        .catch(error => {
            console.error('Error fetching PIN code details:', error);
            alert('Something went wrong while fetching details. Please try again.');
        });
}

document.getElementById('pin').addEventListener('input', function () {
    const pinCode = this.value.trim();
    if (pinCode.length === 6) {
        fetchAddressDetails(pinCode);
    } else {
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('country').value = '';
    }
});


    </script>
    <script src="config.js"></script>
</body>

</html>